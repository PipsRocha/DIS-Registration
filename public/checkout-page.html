<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Checkout - DIS 2025</title>
    
      <!--Bootstrap -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

      <!-- Checkout SDK -->
      <script src="https://cdn.easypay.pt/checkout/2.6.2/"></script>
     </head>
      
       <body>
         <!-- Custom Colors-->
         <style>
           body {
             background-color: #F9F9F9;
             color: #005c99;
             font-family: 'Arial', sans-serif;
           }
       </style>
       
        <!--Heading-->
        <nav class="navbar sticky-top navbar-expand-m justify-content-between flex-column flex-md-row navbar-light" style="background-color: #F9F9F9;">
        <a class="navbar-brand" href="https://dis.acm.org/2025/">
            <img src="images/DIS_branding-08.png" width="60" alt=""> DIS 2025
        </a>
            <a href="index.html" class="btn btn-link"> Main Registration Page</a>
            <a href="https://dis.acm.org/2025/attending" class="btn btn-link"> Registration Rates and Information </a>
        </nav>
    
        <div class="float-sm-left" style="padding-bottom:2vh;">
        <img src="images/header_homepage.jpg" class="img-fluid" alt="Responsive image">
        </div>

      <!-- Checkout Container -->
      <div id="initial-checkout"></div>
      <div id="easypay-checkout"></div>

    <!-- Fetch Data and Initialize Checkout -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const checkoutData = JSON.parse(localStorage.getItem('checkoutData'));
        console.log(checkoutData);
        
        if (!checkoutData) {
          alert('No checkout data found. Redirecting back to registration page.');
          window.location.href = 'index.html';
          return;
        }

        // Display user information and total amount
        document.getElementById('initial-checkout').innerHTML = `
          <h4>User Details</h4>
          <p><strong>Name:</strong> ${checkoutData.personalInfo.name}</p>
          <p><strong>Email:</strong> ${checkoutData.personalInfo.email}</p>
          <p><strong>Registration Type:</strong> ${checkoutData.personalInfo.registrationType}</p>
          <p><strong>Total Amount:</strong> â‚¬${checkoutData.cartTotal.toFixed(2)}</p>
          <select id="paymentType" name="paymentType" required>
            <option value="cc">Credit Card</option>
            <option value="mb">Multibanco</option>
            <option value="vi">Bank Transfer</option>
          </select>
          <div class="btn-purchase" style="margin-top: 10%;">
            <button type="button" class="btn btn-dark btn-purchase" id="payTicket" onClick="createCheckoutSession()">PAY</button>
          </div>`;
      });

      /** Define the createCheckoutSession function */
      function createCheckoutSession() {
        const paymentType = document.getElementById('paymentType').value;

        const realData = {
          personalInfo: JSON.parse(localStorage.getItem('checkoutData')).personalInfo,
          cartTotal: JSON.parse(localStorage.getItem('checkoutData')).cartTotal,
          paymentType: paymentType
        };

        // Make an AJAX request to the backend to create the checkout session
        const req = new XMLHttpRequest();
        req.onreadystatechange = (e) => {
          if (req.readyState === XMLHttpRequest.DONE) {
            if (req.status === 200) {
              const manifest = JSON.parse(req.responseText);
              initEasypayCheckoutSDK(manifest);
            } else {
              console.error(`Error ${req.status} ${req.statusText}`, req.responseText);
            }
          }
        };
        req.open('POST', '/checkoutmanifest');
        req.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        req.send(JSON.stringify(realData));
      }

      /** Used to store the checkout instance and later unmount it. */
      let checkoutInstance;
      let manifest;

      /** The code we want to run when Checkout finishes successfully. */
      function onCheckoutClose() {
        checkoutInstance.unmount();
        document.write('Your order was received. Thank you.');
      }

      /** The code we want to run on Checkout errors. */
      function onCheckoutError(error) {
        checkoutInstance.unmount();
        switch (error.code) {
          case 'checkout-expired':
            getCheckoutManifest();
            break;
          case 'already-paid':
            document.write('Your order was already paid. Thank you.');
            break;
          case 'checkout-canceled':
            document.write('Your order was canceled.');
            break;
          default:
            document.write('Unable to process payment, please try again.');
        }
      }

      function initEasypayCheckoutSDK(manifest) {
        let config = {
          onClose: onCheckoutClose,
          onError: onCheckoutError,
          language: 'en',
          logoUrl:
            sessionStorage.getItem('logoUrl') === 'true'
              ? 'https://easypay-cdn-delivery.s3.eu-central-1.amazonaws.com/emails/easypay_logo.svg'
              : '',
          testing: true,
        };
        for (const key of Object.keys(sessionStorage)) {
          const item = sessionStorage.getItem(key);
          if (item === 'true' || item === 'false') {
            if (key !== 'logoUrl') {
              config[key] = item === 'true';
            }
          } else if (['inputBorderRadius', 'buttonBorderRadius', 'baseFontSize'].includes(key)) {
            config[key] = parseInt(item);
          } else {
            config[key] = item;
          }
        }
        checkoutInstance = easypayCheckout.startCheckout(manifest, config);
        checkoutInstance.mount('#easypay-checkout'); // Mounting the instance to the div
      }
    </script>

      <!--Footer-->
     <div class="container" style="padding:2vh;">
      <div class="row align-items-center justify-content-center">
          <a class="btn btn-floating" href="https://hci.social/@dis" aria-label="mastodon" role="button"><i class="bi bi-mastodon" ></i></a>
         <!-- <a class="btn btn-floating" href="https://x.com/acm_dis" aria-label="x" role="button"><i class="bi bi-x" ></i></a> -->
          <a class="btn btn-floating" href="https://www.instagram.com/acm_dis/" aria-label="instagram" role="button"><i class="bi bi-instagram"></i></a>
          <a class="btn btn-floating" href="https://www.linkedin.com/company/acm-dis" aria-label="linkedin" role="button"><i class="bi bi-linkedin"></i></a>
          <!-- <a class="btn btn-floating" href="https://acm-dis.bsky.social/" aria-label="bluesky" role="button"><i class="fa-brands fa-bluesky"></i></a>
          <a class="btn btn-floating" href="https://www.threads.net/@acm_dis" aria-label="threads" role="button"><i class="bi bi-threads"></i></a> -->
        </div>
      
      <div class="row justify-content-center"  style="padding:2vh;">
        <div class="col">
          <img alt="" src="https://images.cvent.com/805440b54d1d4794ad337ef0b9cb88e5/pix/0a24906b749441e9b5bd370e489d4f5a!_!c3da50606b948eb8450cb110f8df6b9c.jpeg?f=webp" style="max-width: 20vh;">
        </div>
        <div class="col">
          <img alt="" src="https://images.cvent.com/805440b54d1d4794ad337ef0b9cb88e5/pix/9d1b62fd7a7140d08267ebaf7ff88043!_!dffc38a4627d06d5d8305029c800b30a.jpg?f=webp" style="max-width: 20vh;">
        </div>
        <div class="col">
          <img alt="" src="https://dis.acm.org/2025/wp-content/uploads/2025/01/logo_ITI-crop-300x144.png" style="max-width: 20vh;">
        </div> <div class="col">
          <img alt="" src="https://dis.acm.org/2025/wp-content/uploads/2025/01/logo_Madeira-crop-300x109.png" style="max-width: 20vh;">
        </div>
      </div>
  </div>
   
    </body>
</html>